<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Risk Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 500px; margin: auto; }
    input, select, button { width: 100%; padding: 8px; margin: 6px 0; }
    canvas, #liveChart { margin-top: 20px; }
    #liveChart { width: 100%; height: 400px; border: 1px solid #ccc; }
    #timeframe { width: auto; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Trading Risk Calculator</h2>

    <label for="symbol">Market Symbol:</label>
    <input list="symbols" id="symbol" placeholder="Enter market symbol">
    <datalist id="symbols">
      <option value="EURUSD"><option value="GBPUSD"><option value="USDJPY"><option value="USDCHF">
      <option value="AUDUSD"><option value="USDCAD"><option value="NZDUSD">
      <option value="XAUUSD"><option value="XAGUSD"><option value="WTIUSD"><option value="NGAS">
      <option value="US30"><option value="NAS100"><option value="SPX500">
      <option value="BTCUSD"><option value="ETHUSD"><option value="BNBUSD"><option value="XRPUSD">
      <option value="AAPL"><option value="TSLA"><option value="AMZN"><option value="MSFT"><option value="GOOGL">
    </datalist>

    <label for="accountSize">Account Size ($):</label>
    <input type="number" id="accountSize" placeholder="e.g. 10000">

    <label for="riskPercent">Risk % per Trade:</label>
    <input type="number" id="riskPercent" placeholder="e.g. 1">

    <label for="entry">Entry Price:</label>
    <input type="number" id="entry" placeholder="e.g. 1950">

    <label for="stop">Stop Loss Price:</label>
    <input type="number" id="stop" placeholder="e.g. 1940">

    <label for="target">Target Price:</label>
    <input type="number" id="target" placeholder="e.g. 1970">

    <label for="direction">Direction:</label>
    <select id="direction">
      <option value="buy">Buy (Long)</option>
      <option value="sell">Sell (Short)</option>
    </select>
    <br><br>

    <button onclick="calculate()">Calculate</button>
    <button onclick="exportCSV()">Export MT5 Order (CSV)</button>

    <h3>Result:</h3>
    <pre id="result"></pre>

    <h3>Live Chart</h3>
    <label for="timeframe">Timeframe:</label>
    <select id="timeframe" onchange="reloadChart()">
      <option value="1min">1m</option>
      <option value="5min">5m</option>
      <option value="15min">15m</option>
      <option value="1h" selected>1h</option>
      <option value="4h">4h</option>
      <option value="1day">1d</option>
    </select>

    <div id="liveChart"></div>
  </div>

<script>
// -------- Contract size lookup ----------
function getContractSize(symbol) {
  symbol = (symbol || "").toUpperCase();
  const map = {
    "EURUSD": 100000, "GBPUSD": 100000, "USDJPY": 100000, "AUDUSD": 100000,
    "USDCAD": 100000, "USDCHF": 100000, "NZDUSD": 100000,
    "XAUUSD": 100, "XAGUSD": 5000, "WTIUSD": 1000, "USOIL": 1000, "BRENT": 1000,
    "BTCUSD": 1, "ETHUSD": 1, "LTCUSD": 100, "XRPUSD": 10000,
    "AAPL": 1, "TSLA": 1, "MSFT": 1, "AMZN": 1, "GOOGL": 1
  };
  if (map[symbol]) return map[symbol];
  if (symbol.length === 6 && symbol.endsWith("USD")) return 100000;
  return 1;
}

// -------- Calculator ----------
function calculate() {
  let direction = document.getElementById("direction").value.toLowerCase();
  const symbol = (document.getElementById("symbol")?.value || "").toUpperCase().trim();
  const accountSize = parseFloat(document.getElementById("accountSize")?.value || 0);
  const riskPercent = parseFloat(document.getElementById("riskPercent")?.value || 0);
  const entry = parseFloat(document.getElementById("entry")?.value);
  const stop = parseFloat(document.getElementById("stop")?.value);
  const target = parseFloat(document.getElementById("target")?.value);

  const outputEl = document.getElementById("result");
  if (!symbol || isNaN(accountSize) || isNaN(riskPercent) || isNaN(entry) || isNaN(stop)) {
    alert("Please fill all fields correctly."); return;
  }

  const riskAmount = accountSize * (riskPercent / 100);
  const stopDiff = Math.abs(entry - stop);
  if (stopDiff === 0) { alert("Entry and Stop must be different."); return; }

  const units = riskAmount / stopDiff;
  const contractSize = getContractSize(symbol);
  const lots = units / contractSize;

  let rewardAmount = 0, rrRatio = 0;
  if (!isNaN(target)) {
    const rewardDiff = Math.abs(target - entry);
    rewardAmount = rewardDiff * units;
    rrRatio = (riskAmount > 0) ? (rewardAmount / riskAmount) : 0;
  }

  outputEl.innerHTML = `
<strong>Trade Command:</strong> ${direction.toUpperCase()} ${symbol}
<strong>Risk Amount:</strong> $${riskAmount.toFixed(2)}
<strong>Lot Size:</strong> ${lots.toFixed(2)} lots
<strong>Potential Reward:</strong> $${rewardAmount.toFixed(2)}
<strong>R:R Ratio:</strong> ${rrRatio.toFixed(2)}
  `;

  window.lastCalc = { direction, symbol, entry, stop, target, units, lots, riskAmount, rewardAmount, rrRatio };
  loadLiveChart(symbol);
}

// -------- Live Chart ----------
async function loadLiveChart(symbol) {
  const apiKey = "YOUR_TWELVE_API_KEY_HERE"; // replace with your TwelveData API key
  const interval = document.getElementById("timeframe").value;
  const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${interval}&outputsize=50&apikey=${apiKey}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.values) { console.error("API error:", data); return; }

    const candles = data.values.reverse().map(d => ({
      time: new Date(d.datetime).getTime() / 1000,
      open: parseFloat(d.open),
      high: parseFloat(d.high),
      low: parseFloat(d.low),
      close: parseFloat(d.close)
    }));

    document.getElementById("liveChart").innerHTML = "";
    const chart = LightweightCharts.createChart(document.getElementById("liveChart"), { width: 480, height: 400 });
    const candleSeries = chart.addCandlestickSeries();
    candleSeries.setData(candles);

  } catch (err) {
    console.error("Chart load failed", err);
  }
}

// reload chart on timeframe change
function reloadChart() {
  if (window.lastCalc && window.lastCalc.symbol) {
    loadLiveChart(window.lastCalc.symbol);
  }
}

// -------- CSV Export ----------
function exportCSV() {
  if (!window.lastCalc) { alert("Please Calculate first."); return; }
  const L = window.lastCalc;
  const header = "TradeCommand,Symbol,Direction,Entry,StopLoss,TakeProfit,Units,Lots,PotentialReward,R_Ratio\n";
  const row = [
    `"${L.direction.toUpperCase()} ${L.symbol}"`,
    L.symbol, L.direction, L.entry, L.stop, L.target || "",
    L.units.toFixed(2), L.lots.toFixed(6), L.rewardAmount.toFixed(2), L.rrRatio.toFixed(2)
  ].join(",");
  const csvContent = header + row + "\n";
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "mt5_order.csv";
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
</script>
</body>
</html>
