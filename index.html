<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Calculator with Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
</head>
<body style="font-family: Arial; padding:20px;">

  <h2>Risk Management Calculator</h2>

  <label>Market:
    <select id="market" onchange="loadSymbols()">
      <option value="forex">Forex</option>
      <option value="crypto">Crypto</option>
      <option value="commodities">Commodities</option>
      <option value="stocks">Stocks</option>
    </select>
  </label>

  <label>Symbol:
    <select id="symbol"></select>
  </label><br><br>

  <label>Account Balance: <input type="number" id="balance" value="10000"></label><br>
  <label>Risk % per Trade: <input type="number" id="risk" value="1"></label><br>
  <label>Entry Price: <input type="number" id="entry" value="1.1000" step="0.0001"></label><br>
  <label>Stop Loss Price: <input type="number" id="stop" value="1.0950" step="0.0001"></label><br>
  <label>Target Price: <input type="number" id="target" value="1.1100" step="0.0001"></label><br><br>

  <button onclick="calculate()">Calculate</button>
  <button onclick="exportCSV()">Export MT5 CSV</button>

  <h3>Result:</h3>
  <pre id="result"></pre>

  <canvas id="chart" width="400" height="200"></canvas>

<script>
const symbols = {
  forex: ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD"],
  crypto: ["BTCUSD","ETHUSD","XRPUSD","BNBUSD"],
  commodities: ["XAUUSD","XAGUSD","WTIUSD","NGASUSD"],
  stocks: ["AAPL","TSLA","MSFT","AMZN"]
};

function loadSymbols() {
  const market = document.getElementById("market").value;
  const symbolSelect = document.getElementById("symbol");
  symbolSelect.innerHTML = "";
  symbols[market].forEach(sym => {
    let opt = document.createElement("option");
    opt.value = sym; opt.text = sym;
    symbolSelect.add(opt);
  });
}
loadSymbols();

function getLotSize(symbol, units) {
  symbol = symbol.toUpperCase();

  if (symbol.length === 6 && symbol.endsWith("USD")) {
    return units / 100000;   // Forex
  } else if (symbol === "XAUUSD") {
    return units / 100;      // Gold
  } else if (symbol === "XAGUSD") {
    return units / 5000;     // Silver
  } else if (symbol.includes("WTI") || symbol.includes("OIL")) {
    return units / 1000;     // Oil
  } else if (["BTCUSD","ETHUSD","BNBUSD","XRPUSD"].includes(symbol)) {
    return units / 1;        // Crypto
  } else {
    return units / 1;        // Stocks or fallback
  }
}

function calculate() {
  let balance = parseFloat(document.getElementById("balance").value);
  let riskPercent = parseFloat(document.getElementById("risk").value);
  let entry = parseFloat(document.getElementById("entry").value);
  let stop = parseFloat(document.getElementById("stop").value);
  let target = parseFloat(document.getElementById("target").value);
  let symbol = document.getElementById("symbol").value;

  let riskAmount = balance * (riskPercent/100);
  let stopLoss = Math.abs(entry - stop);
  let unitSize = stopLoss > 0 ? riskAmount / stopLoss : 0;
  let lotSize = getLotSize(symbol, unitSize);

  document.getElementById("result").innerText =
    `Symbol: ${symbol}
Risk Amount: $${riskAmount.toFixed(2)}
Position Size: ${unitSize.toFixed(2)} units
Lot Size: ${lotSize.toFixed(4)} lots`;

  drawChart(entry, stop, target);
}

function drawChart(entry, stop, target) {
  const ctx = document.getElementById("chart").getContext("2d");
  if (window.tradeChart) window.tradeChart.destroy();

  let candles = [];
  let base = entry;
  for (let i = 0; i < 20; i++) {
    let open = base + (Math.random() - 0.5) * 2;
    let close = open + (Math.random() - 0.5) * 2;
    let high = Math.max(open, close) + Math.random();
    let low = Math.min(open, close) - Math.random();
    candles.push({ t: i, o: open, h: high, l: low, c: close });
    base = close;
  }

  window.tradeChart = new Chart(ctx, {
    type: "candlestick",
    data: { datasets: [{ label: "Price", data: candles }] },
    options: {
      plugins: {
        annotation: {
          annotations: {
            entry: { type:"line", yMin:entry, yMax:entry, borderColor:"green", borderWidth:2,
                     label:{ content:"Entry", enabled:true }},
            stop: { type:"line", yMin:stop, yMax:stop, borderColor:"red", borderWidth:2,
                    label:{ content:"Stop", enabled:true }},
            target: { type:"line", yMin:target, yMax:target, borderColor:"orange", borderWidth:2,
                      label:{ content:"Target", enabled:true }}
          }
        }
      },
      responsive: true,
      scales: { x: { type: "linear" }, y: { beginAtZero: false } }
    }
  });
}

function exportCSV() {
  let result = document.getElementById("result").innerText;
  if (!result) { alert("Please calculate first."); return; }

  let rows = result.split("\n").map(r => r.split(": "));
  let csvContent = rows.map(r => r.join(",")).join("\n");

  let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "mt5_order.csv";
  link.click();
}
</script>

</body>
</html>
