<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Risk Calculator</title>
  <!-- Chart.js core -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js financial plugin for candlesticks -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 500px; margin: auto; }
    input, select, button { width: 100%; padding: 8px; margin: 6px 0; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Trading Risk Calculator</h2>

    <label for="symbol">Market Symbol:</label>
    <input list="symbols" id="symbol" placeholder="Enter market symbol">
    <datalist id="symbols">
      <!-- Forex majors -->
      <option value="EURUSD">
      <option value="GBPUSD">
      <option value="USDJPY">
      <option value="USDCHF">
      <option value="AUDUSD">
      <option value="USDCAD">
      <option value="NZDUSD">

      <!-- Commodities -->
      <option value="XAUUSD"> <!-- Gold -->
      <option value="XAGUSD"> <!-- Silver -->
      <option value="WTIUSD"> <!-- Crude Oil -->
      <option value="NGAS">   <!-- Natural Gas -->

      <!-- Indices -->
      <option value="US30">
      <option value="NAS100">
      <option value="SPX500">

      <!-- Crypto -->
      <option value="BTCUSD">
      <option value="ETHUSD">
      <option value="BNBUSD">
      <option value="XRPUSD">

      <!-- Stocks -->
      <option value="AAPL">
      <option value="TSLA">
      <option value="AMZN">
      <option value="MSFT">
      <option value="GOOGL">
    </datalist>

    <label for="accountSize">Account Size ($):</label>
    <input type="number" id="accountSize" placeholder="e.g. 10000">

    <label for="riskPercent">Risk % per Trade:</label>
    <input type="number" id="riskPercent" placeholder="e.g. 1">

    <label for="entry">Entry Price:</label>
    <input type="number" id="entry" placeholder="e.g. 1950">

    <label for="stop">Stop Loss Price:</label>
    <input type="number" id="stop" placeholder="e.g. 1940">

    <label for="target">Target Price:</label>
    <input type="number" id="target" placeholder="e.g. 1970">

    <button onclick="calculate()">Calculate</button>
    <button onclick="exportCSV()">Export MT5 Order (CSV)</button>

    <h3>Result:</h3>
    <pre id="result"></pre>

    <canvas id="chart" width="400" height="200"></canvas>
  </div>

  <script>
  // ---------- REPLACE your old getLotSize() with this ----------
function getContractSize(symbol) {
  // return how many "units" are in 1 standard lot for the given symbol
  // adjust these defaults to match your broker if needed
  symbol = (symbol || "").toUpperCase();

  const map = {
    // Forex majors/minors (1 lot = 100,000 base units)
    "EURUSD": 100000, "GBPUSD": 100000, "USDJPY": 100000, "AUDUSD": 100000,
    "USDCAD": 100000, "USDCHF": 100000, "NZDUSD": 100000,

    // Metals / Commodities (common contract sizes)
    "XAUUSD": 100,    // Gold: 1 lot = 100 oz
    "XAGUSD": 5000,   // Silver: 1 lot = 5000 oz
    "WTIUSD": 1000,   // Oil (WTI): 1 lot = 1000 barrels (common)
    "USOIL": 1000,
    "BRENT": 1000,

    // Crypto (common defaults - verify with your broker)
    "BTCUSD": 1,      // 1 lot = 1 BTC (common)
    "ETHUSD": 1,      // many brokers use 1 lot = 1 ETH (or sometimes 10) -> check broker
    "LTCUSD": 100,    // example
    "XRPUSD": 10000,  // example

    // Stocks (1 lot = 1 share)
    "AAPL": 1, "TSLA": 1, "MSFT": 1, "AMZN": 1, "GOOGL": 1
  };

  if (map[symbol]) return map[symbol];

  // sensible defaults:
  // - if looks like a forex pair (6 chars and ends with USD) assume 100000
  if (symbol.length === 6 && symbol.endsWith("USD")) return 100000;

  // otherwise fallback to 1 (stocks/crypto single-share/coin style)
  return 1;
}

// ---------- REPLACE your old calculate() with this ----------
function calculate() {
  // get values from your inputs - change IDs if yours are different
  const symbol = document.getElementById("symbol").value.trim().toUpperCase();
  const accountSize = parseFloat(document.getElementById("accountSize")?.value || document.getElementById("balance")?.value || 0);
  const riskPercent = parseFloat(document.getElementById("risk")?.value || document.getElementById("riskPercent")?.value || 0);
  const entry = parseFloat(document.getElementById("entry").value);
  const stop = parseFloat(document.getElementById("stop").value);
  const target = parseFloat(document.getElementById("target")?.value || document.getElementById("tp")?.value || 0);

  if (!symbol) { alert("Enter symbol (e.g. XAUUSD)."); return; }
  if (isNaN(accountSize) || isNaN(riskPercent) || isNaN(entry) || isNaN(stop)) {
    alert("Please fill numeric Account, Risk%, Entry and Stop fields.");
    return;
  }

  // Step 1: risk in account currency
  const riskAmount = accountSize * (riskPercent / 100);

  // Step 2: price difference (in price units)
  const priceDiff = Math.abs(entry - stop);
  if (priceDiff === 0) { alert("Entry and Stop must be different."); return; }

  // Step 3: compute units (base units: oz, shares, base currency units, coins...)
  // units = how many base-units you would hold so that priceDiff * units = riskAmount
  const units = riskAmount / priceDiff;

  // Step 4: convert units -> lots using contract size for this symbol
  const contractSize = getContractSize(symbol); // e.g. 100 for XAUUSD, 100000 for EURUSD
  const lots = units / contractSize;

  // Format display: show more decimals for small lot sizes
  const lotDisplay = lots.toFixed(6);     // 6 decimals (safe for micro-lots)
  const unitsDisplay = (contractSize === 1) ? units.toFixed(4) : units.toFixed(2);

  // Unit label (human friendly)
  let unitLabel = "units";
  if (symbol === "XAUUSD") unitLabel = "oz";
  else if (symbol === "XAGUSD") unitLabel = "oz";
  else if (symbol.startsWith("BTC") || symbol.includes("BTC")) unitLabel = "coins";
  else if (contractSize === 1) unitLabel = "shares/coins";

  // Show result in your result element (change ID if needed)
  const resultText =
    `Symbol: ${symbol}\n` +
    `Risk Amount: ${riskAmount.toFixed(2)} (account currency)\n` +
    `Price difference (entryâ†”stop): ${priceDiff}\n` +
    `Position Size: ${unitsDisplay} ${unitLabel}\n` +
    `Lot Size: ${lotDisplay} lots\n` +
    (isFinite(target) ? `Target: ${target}` : "");

  document.getElementById("result").innerText = resultText;

  // save lastCalc for CSV etc. if you use it
  window.lastCalc = { symbol, entry, stop, target, units, lots, accountSize, riskAmount };

  // (optional) update chart
  if (typeof drawChart === "function") drawChart(entry, stop, target);
}
    function drawChart(entry, stop, target) {
      const ctx = document.getElementById("chart").getContext("2d");
      if (window.tradeChart) window.tradeChart.destroy();

      // Generate 20 random candles around entry
      let candles = [];
      let base = entry;
      for (let i = 0; i < 20; i++) {
        let open = base + (Math.random() - 0.5) * 5;
        let close = open + (Math.random() - 0.5) * 5;
        let high = Math.max(open, close) + Math.random() * 2;
        let low = Math.min(open, close) - Math.random() * 2;
        candles.push({ x: i, o: open, h: high, l: low, c: close });
        base = close;
      }

      window.tradeChart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [{
            label: "Price",
            data: candles
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { type: "linear" },
            y: { beginAtZero: false }
          },
          plugins: {
            annotation: {
              annotations: {
                entry: {
                  type: "line",
                  yMin: entry,
                  yMax: entry,
                  borderColor: "green",
                  borderWidth: 2,
                  label: { content: "Entry", enabled: true }
                },
                stop: {
                  type: "line",
                  yMin: stop,
                  yMax: stop,
                  borderColor: "red",
                  borderWidth: 2,
                  label: { content: "Stop", enabled: true }
                },
                target: {
                  type: "line",
                  yMin: target,
                  yMax: target,
                  borderColor: "orange",
                  borderWidth: 2,
                  label: { content: "Target", enabled: true }
                }
              }
            }
          }
        }
      });
    }

    function exportCSV() {
      let symbol = document.getElementById("symbol").value;
      let accountSize = parseFloat(document.getElementById("accountSize").value);
      let riskPercent = parseFloat(document.getElementById("riskPercent").value);
      let entry = parseFloat(document.getElementById("entry").value);
      let stop = parseFloat(document.getElementById("stop").value);
      let target = parseFloat(document.getElementById("target").value);

      let riskAmount = accountSize * (riskPercent / 100);
      let stopDistance = Math.abs(entry - stop);
      let unitSize = riskAmount / stopDistance;
      let lotSize = getLotSize(symbol, unitSize);

      let csvContent = "data:text/csv;charset=utf-8,"
        + "Symbol,Entry,StopLoss,Target,Units,Lots\n"
        + `${symbol},${entry},${stop},${target},${unitSize.toFixed(2)},${lotSize.toFixed(2)}\n`;

      let link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "mt5_order.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>




