<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Risk Calculator with Live Chart (fixed)</title>

  <!-- Chart.js v3 (locked), Luxon + adapter, and financial plugin (v0.2.1) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@2.6.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.4.0/dist/chartjs-adapter-luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; font-size: 20px; }
    input, select, button { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ddd; border-radius: 6px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; }
    canvas { margin-top: 15px; width:100% !important; height:300px !important; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Trading Risk Calculator</h2>

      <label for="symbol">Market Symbol:</label>
      <input list="symbols" id="symbol" placeholder="Enter market symbol">
      <datalist id="symbols">
        <option value="EURUSD"><option value="GBPUSD"><option value="USDJPY"><option value="USDCHF">
        <option value="AUDUSD"><option value="USDCAD"><option value="NZDUSD">
        <option value="XAUUSD"><option value="XAGUSD"><option value="WTIUSD"><option value="NGAS">
        <option value="US30"><option value="NAS100"><option value="SPX500">
        <option value="BTCUSDT"><option value="ETHUSDT"><option value="BNBUSDT"><option value="XRPUSDT">
        <option value="AAPL"><option value="TSLA"><option value="AMZN"><option value="MSFT"><option value="GOOGL">
      </datalist>

      <label for="accountSize">Account Size ($):</label>
      <input type="number" id="accountSize" placeholder="e.g. 10000">

      <label for="riskPercent">Risk % per Trade:</label>
      <input type="number" id="riskPercent" placeholder="e.g. 1">

      <label for="entry">Entry Price:</label>
      <input type="number" id="entry" placeholder="e.g. 1950">

      <label for="stop">Stop Loss Price:</label>
      <input type="number" id="stop" placeholder="e.g. 1940">

      <label for="target">Target Price:</label>
      <input type="number" id="target" placeholder="e.g. 1970">

      <label for="direction">Direction:</label>
      <select id="direction">
        <option value="buy">Buy (Long)</option>
        <option value="sell">Sell (Short)</option>
      </select>
      
      <button onclick="calculate()">Calculate</button>
      <button onclick="exportCSV()">Export MT5 Order (CSV)</button>

      <h3>Result:</h3>
      <pre id="result"></pre>
      <p class="small">Tip: open your browser console to see debug logs from API requests.</p>
    </div>

    <div class="card">
      <h2>Live Chart</h2>

      <label>Timeframe</label>
      <select id="timeframe" onchange="updateChart()">
        <option value="1m">1 Minute</option>
        <option value="5m">5 Minutes</option>
        <option value="15m">15 Minutes</option>
        <option value="1h" selected>1 Hour</option>
        <option value="1d">1 Day</option>
      </select>

      <canvas id="chartCanvas"></canvas>
    </div>
  </div>

  <script>
  // --- Register financial controllers/elements (must be done after plugin loaded) ---
  (function registerFinancial() {
    const financial = window['chartjs-chart-financial'];
    if (!financial) {
      console.error('chartjs-chart-financial not found on window. Did the script load?');
      return;
    }
    Chart.register(
      financial.CandlestickController,
      financial.CandlestickElement,
      financial.OhlcController,
      financial.OhlcElement
    );
    console.log('Registered chartjs-chart-financial controllers/elements.');
  })();

  // ---------------- Helpers ----------------
  function getContractSize(symbol) {
    symbol = (symbol || '').toUpperCase();
    const map = {
      "EURUSD":100000,"GBPUSD":100000,"USDJPY":100000,"AUDUSD":100000,
      "USDCAD":100000,"USDCHF":100000,"NZDUSD":100000,
      "XAUUSD":100,"XAGUSD":5000,"WTIUSD":1000,"NGAS":1000,
      "BTCUSDT":1,"ETHUSDT":1,"BNBUSDT":1,"XRPUSDT":1000,
      "AAPL":1,"TSLA":1,"MSFT":1,"AMZN":1,"GOOGL":1
    };
    if (map[symbol]) return map[symbol];
    if (symbol.length === 6 && symbol.endsWith('USD')) return 100000;
    return 1;
  }

  function mapIntervalForTwelve(interval) {
    switch(interval) {
      case '1m': return '1min';
      case '5m': return '5min';
      case '15m': return '15min';
      case '1h': return '1h';
      case '1d': return '1day';
      default: return interval;
    }
  }

  function isCryptoSymbol(symbol) {
    // treat common crypto suffixes as crypto for Binance
    return /USDT$|BTC$|ETH$|BNB$/i.test(symbol);
  }

  // ---------------- Risk Calculator ----------------
  function calculate() {
    const direction = document.getElementById('direction').value.toLowerCase();
    const symbol = (document.getElementById('symbol')?.value || '').toUpperCase().trim();
    const accountSize = parseFloat(document.getElementById('accountSize')?.value || 0);
    const riskPercent = parseFloat(document.getElementById('riskPercent')?.value || 0);
    const entry = parseFloat(document.getElementById('entry')?.value);
    const stop = parseFloat(document.getElementById('stop')?.value);
    let target = parseFloat(document.getElementById('target')?.value);

    const outputEl = document.getElementById('result');

    if (!symbol) { alert('Please enter a symbol.'); return; }
    if (![accountSize, riskPercent, entry, stop].every(v => !isNaN(v))) {
      alert('Please fill all fields correctly.'); return;
    }

    const riskAmount = accountSize * (riskPercent/100);
    const stopDiff = Math.abs(entry - stop);
    if (stopDiff === 0) { alert('Entry and Stop must differ.'); return; }

    const units = riskAmount / stopDiff;
    const contractSize = getContractSize(symbol);
    const lots = units / contractSize;

    let rewardAmount = 0, rrRatio = 0;
    if (!isNaN(target)) {
      const rewardDiff = Math.abs(target - entry);
      rewardAmount = rewardDiff * units;
      rrRatio = (riskAmount > 0) ? (rewardAmount / riskAmount) : 0;
    }

    outputEl.innerHTML = `
      <p><strong>Trade Command:</strong> ${direction.toUpperCase()} ${symbol}</p>
      <p><strong>Risk Amount:</strong> $${riskAmount.toFixed(2)}</p>
      <p><strong>Lot Size:</strong> ${lots.toFixed(4)} lots</p>
      <p><strong>Potential Reward:</strong> $${rewardAmount.toFixed(2)}</p>
      <p><strong>R:R Ratio:</strong> ${rrRatio.toFixed(2)}</p>
    `;

    window.lastCalc = { symbol, direction, entry, stop, target, units, lots, riskAmount, rewardAmount, rrRatio };
    updateChart();
  }

  // ---------------- Live Chart ----------------
  async function fetchChartData(symbol, interval) {
    let data = [];
    try {
      console.log('Fetching chart data for', symbol, 'interval', interval);
      if (isCryptoSymbol(symbol)) {
        // Binance expects intervals like 1m,5m,15m,1h,1d
        const binInterval = interval;
        const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${binInterval}&limit=100`;
        const res = await fetch(url);
        const raw = await res.json();
        console.log('Binance raw:', raw && raw.length ? `array(${raw.length})` : raw);
        if (!Array.isArray(raw)) throw new Error('Binance returned error: ' + JSON.stringify(raw));
        data = raw.map(c => ({ x: new Date(c[0]), o: +c[1], h: +c[2], l: +c[3], c: +c[4] }));
      } else {
        // TwelveData requires intervals like 1min,5min,15min,1h,1day etc.
        const tdInterval = mapIntervalForTwelve(interval);
        const apiKey = "YOUR_TWELVE_API_KEY_HERE"; // <-- replace with your TwelveData key
        if (!apiKey || apiKey === 'YOUR_TWELVE_API_KEY_HERE') {
          console.warn('TwelveData API key not set - returning empty data for stocks/forex. Replace YOUR_TWELVE_API_KEY_HERE.');
        }
        const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=${tdInterval}&apikey=${apiKey}&outputsize=100`;
        const res = await fetch(url);
        const raw = await res.json();
        console.log('TwelveData raw:', raw);
        if (raw.status === 'error') throw new Error(raw.message || JSON.stringify(raw));
        if (raw.values && Array.isArray(raw.values)) {
          data = raw.values.slice().reverse().map(c => ({ x: new Date(c.datetime), o: +c.open, h: +c.high, l: +c.low, c: +c.close }));
        }
      }
    } catch (err) {
      console.error('fetchChartData error:', err);
      // don't throw — return empty array so caller can show fallback
    }
    return data;
  }

  // Small fallback demo dataset generator (so you always see candles)
  function makeFallbackData(count = 60, center = 100) {
    const out = [];
    let time = Date.now() - count * 60 * 1000;
    let price = center;
    for (let i = 0; i < count; i++) {
      const open = price + (Math.random() - 0.5) * 1.2;
      const close = open + (Math.random() - 0.5) * 2.0;
      const high = Math.max(open, close) + Math.random() * 1.5;
      const low = Math.min(open, close) - Math.random() * 1.5;
      out.push({ x: new Date(time), o: +open.toFixed(4), h: +high.toFixed(4), l: +low.toFixed(4), c: +close.toFixed(4) });
      time += 60 * 1000;
      price = close;
    }
    return out;
  }

  async function updateChart() {
    const symbol = (document.getElementById('symbol').value || '').toUpperCase().trim();
    const interval = document.getElementById('timeframe').value;
    if (!symbol) {
      console.log('No symbol set, skipping chart update.');
      return;
    }

    const rawData = await fetchChartData(symbol, interval);
    const data = (rawData && rawData.length) ? rawData : (window.lastCalc && window.lastCalc.entry ? makeFallbackData(60, window.lastCalc.entry) : makeFallbackData(60, 100));
    if (!rawData || rawData.length === 0) console.warn('No real API data found — using fallback demo dataset.');

    console.log('Chart data sample:', data.slice(0, 4));
    const ctx = document.getElementById('chartCanvas').getContext('2d');

    if (window.chart) window.chart.destroy();

    const unit = (interval === '1d') ? 'day' : 'minute';
    window.chart = new Chart(ctx, {
      type: 'candlestick',
      data: { datasets: [{ label: symbol, data }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            type: 'time',
            time: { unit: unit },
            ticks: { source: 'auto' }
          },
          y: {
            beginAtZero: false,
            position: 'right'
          }
        }
      }
    });
  }

  // ---------------- CSV Export ----------------
  function exportCSV() {
    if (!window.lastCalc) { alert('Please Calculate first.'); return; }
    const L = window.lastCalc;
    const header = "TradeCommand,Symbol,Direction,Entry,StopLoss,TakeProfit,Units,Lots,PotentialReward,R_Ratio\n";
    const row = [
      `"${L.direction.toUpperCase()} ${L.symbol}"`, L.symbol, L.direction, L.entry, L.stop, L.target,
      L.units.toFixed(2), L.lots.toFixed(4), L.rewardAmount.toFixed(2), L.rrRatio.toFixed(2)
    ].join(',');
    const csvContent = header + row + '\n';
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'mt5_order.csv';
    link.click();
  }

  // keep chart in sync when the timeframe changes (and on first calculate)
  // (user interaction triggers updateChart)
  </script>
</body>
</html>
